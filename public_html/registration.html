<!DOCTYPE html>
<html>
    <head>
        <title>Microblog</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="../public/css/bootstrap.min.css">

        <script>
            function loadUser() {
                xhr = new XMLHttpRequest();
                var url = "http://localhost:8085/test";
                xhr.onreadystatechange = function () {
                    if (this.readyState === 4 && this.status === 200) {
                        decode_json_stud(this.responseText);
                        document.getElementById("messages").innerHTML = "Operazione eseguita.";
                    }
                };
                xhr.open("GET", url, true);
                xhr.send();
            }

            function decode_json_user(data) {
                var r = "";
                var parsedJson = JSON.parse(data);
                for (var i = 0; i < parsedJson.response.length; i++) {
                    r += (parsedJson.response[i].username + " " + parsedJson.response[i].email + " " + parsedJson.response[i].email +
                            " " + parsedJson.response[i].id + " <button onclick='deleteUtente();'>Cancella</button> <br>"); //delete al momento non implementata lato server
                }
                document.getElementById("utenti").innerHTML = r;
            }

            function deleteUtente(id) {
                xhr = new XMLHttpRequest();
                var url = "http://localhost:8085//test/" + id;
                xhr.open("DELETE", url, true);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        switch (xhr.status) {
                            case 204:
                                //document.getElementById("messages").innerHTML = "Cancellato";
                                loadUser(); //se cancellato ricarico la lista degli studenti
                                break;
                            case 404:
                                document.getElementById("messages").innerHTML = "Errore 404";
                                break;
                            default:
                                document.getElementById("messages").innerHTML = "Non eseguito.";
                        }
                    }
                };
                xhr.send();
            }



            function insertUser() {
                xhr = new XMLHttpRequest();
                var url = "http://localhost:8085/api/test";
                xhr.open('POST', url, true);
                xhr.setRequestHeader("Content-type", "application/json");
                xhr.withCredentials = false;
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        switch (xhr.status) {
                            case 201:
                                // var frm = document.querySelector('[name="f1"]');
                                document.getElementById("username").value = "";
                                document.getElementById("email").value = "";
                                document.getElementById("password").value = "";
                                // var location = xhr.getResponseHeader('location'); da implementare
                                // document.getElementById("messages").innerHTML = "Inserimento eseguito.";
                                loadUser(); //se inserito ricarico la lista degli studenti
                                break;
                            case 404:
                                document.getElementById("messages").innerHTML = "Errore 404 ";
                                break;
                            default:
                                document.getElementById("messages").innerHTML = "Non eseguito.";
                        }
                    }
                };

                // var frm = document.querySelector('[name="f1"]');
                //   var data = JSON.stringify({"username":frm.elements["username"].value,
                //                           "nome":frm.elements["nome"].value,
                //                           "classe":frm.elements["classe"].value 
                //   });
                var data = JSON.stringify({"username": document.getElementById("username").value,
                    "email": document.getElementById("email").value,
                    "password": document.getElementById("password").value
                });
                xhr.send(data);
            }
        </script>

    </head>

    <body onload="loadUser();">
        <div class="container py-5">
            <div class="row">
                <div class="col-md-12">
                    <ul class="nav nav-fill">
                        <a class="nav-item" href="login.html"><h2>Login</h2></a>
                        <a class="nav-item" href="index.html"><h2>Home</h2></a>
                    </ul>
                    <hr class="mb-5">
                    <button onclick="loadUser();">Carica studenti (esegue una GET sulla collezione /studenti)</button>
                    <p id="messages"></p> <br>
                    <div class="row">

                        <div class="col-md-6 offset-md-3">
                            <span class="anchor" id="formRegister"></span>


                            <!-- form card register -->
                            <div class="card card-outline-secondary">
                                <div class="card-body">
                                    <form class="form" role="form" autocomplete="off" action="/registration">
                                        <div class="form-group">
                                            <label for="inputName">Name</label>
                                            <input type="text" class="form-control" name="username" id="username" placeholder="Full name">
                                        </div>
                                        <div class="form-group">
                                            <label for="inputEmail3">Email</label>
                                            <input type="text" class="form-control" name="email" id="email" placeholder="Email" required="">
                                        </div>
                                        <div class="form-group">
                                            <label for="inputPassword3">Password</label>
                                            <input type="text" class="form-control" name="password"  id="password" placeholder="Password" required="">
                                        </div>
                                        <div class="form-group">
                                            <button onClick="insertUser();" class="btn btn-success btn-lg">Register</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <!-- /form card register -->
                        </div>
                    </div>
                </div>
                <!--/col-->
            </div>
        </div>
        <div id="utenti"></div>
        <!--/container-->
        <script src="jquery-3.5.1.min.js"></script>
        <script src="../public/js/bootstrap.min.js"></script>
    </body>
</html>

